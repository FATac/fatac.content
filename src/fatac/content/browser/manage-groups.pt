<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<head>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1);
                             disable_column_one python:request.set('disable_plone.leftcolumn',1);
                             disable_column_two python:request.set('disable_plone.rightcolumn',1);" />
</head>

<body>

<tal:comment replace="nothing">
    Please note that this template fills the "content" slot instead of the
    "main" slot, this is done so we can provide stuff like the content
    tabs. This also means that we have to supply things that are normally
    present from main_template.
</tal:comment>

<metal:main fill-slot="content">
  <tal:main-macro metal:define-macro="main"
     tal:define="template_id string:@@manage-groups;
                 member context/@@plone_portal_state/member;
                 portal context/@@plone_portal_state/portal;
                 member python:context.portal_membership.getAuthenticatedMember();
                 userid python:member.getId();
                 groups python:context.portal_groups.getGroupsByUserId(member.getId());
                 errors python:request.get('errors', {});
                 userquery python:view.makeQuery(userid=userid);
                 portal_url context/portal_url;
                 showAll python:request.get('showAll', '') and not view.newSearch and 'y';
                 Batch python:modules['Products.CMFPlone'].Batch;
                 b_size python:showAll and len(view.searchResults) or 20;
                 many_groups view/many_groups;
                 mq python:modules['ZTUtils'].make_query;
                 results view/searchResults;
                 resultcount python:len(results);
                 b_start python:0 if showAll or view.newSearch else view.atoi(request.get('b_start',0));
                 b_start python:b_start if (b_start &lt;= resultcount) else (resultcount - resultcount % b_size);
                 b_start python:b_start if (b_start &lt; resultcount) else max(b_start - b_size, 0);
                 batch python:Batch(view.searchResults, b_size, int(b_start));
                 batchformkeys python:['searchstring','_authenticator', 'userid'];">


        <!-- simulating views on the groups/user pages until we have real objects. -->
        <div id="edit-bar">
            <ul id="content-views"
                class="contentViews">
              <li>
                <a href=""
                   tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/dashboard"
                   i18n:translate="label_dashboard">Dashboard</a>
              </li>
<!--
              <li>
                <a href=""
                   tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/@@manage-dashboard"
                   i18n:translate="label_portlets">Edita Portlets</a>
              </li>
-->
              <li class="selected">
                <a href=""
                   tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/@@manage-groups"
                   i18n:translate="">Grups</a>
              </li>
              <li>
                <a href=""
                   tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/@@my-playlists"
                   i18n:translate="">Playlists</a>
              </li>
              <li>
                <a href=""
                   tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/@@my-activity"
                   i18n:translate="">Activitat</a>
              </li>
            </ul>
            <div class="contentActions">&nbsp;</div>
        </div>

        <div metal:use-macro="context/global_statusmessage/macros/portal_message">
          Portal status message
        </div>

        <div id="content" tal:define="many_groups view/many_groups">

            <div class="div_dotted_line_doble_negre">
              <h1 class="arial13c000000upp" i18n:translate="heading_group_memberships_for_fullname">
                Group memberships for
                <span i18n:name="fullname"
                      tal:replace="python:member.getProperty('fullname')" />
                (<span tal:content="userid"
                      tal:omit-tag=""
                      i18n:name="userid">user id</span>)
              </h1>
            </div>


            <div id="actions" class="div_dotted_line_bottom">
                <div style="float:left;">
                  <img rel="filtres" class="arrow_bottom filtres" src="++resource++fatac.theme.images/ico_arrow_down.png" />
                  <span class="arial13c999999" i18n:translate="">Accions</span>
                </div>

                <form action=""
                      name="groups_add"
                      method="post"
                      tal:attributes="action string:$portal_url/@@usergroup-groupdetails">

                      <input class="boto_filtres arial11c666666 actionButtons"
                             type="submit"
                             name="form.button.AddGroup"
                             value="Add New Group"
                             i18n:attributes="value label_add_new_group;"
                      />

                </form>
            </div>

            <div id="content-core">

              <div class="row">
                <div class="span7"> 
                  <h2 class="arial15c666666" i18n:translate="heading_memberships_current">Current group memberships</h2><br/>
                  <table tal:condition="groups" class="dashboardListing" summary="Group Memberships Listing">
                    <tr>
                      <th i18n:translate="listingheader_group_name">Group Name</th>
                      <th>Manage</th>
                      <th i18n:translate="listingheader_group_remove">Remove</th>
                    </tr>
                    <tal:block repeat="group groups">
                        <tr tal:define="oddrow repeat/group/odd;
                                        groupId group/getId;"
                            tal:condition="python: groupId != 'AuthenticatedUsers'"
                            tal:attributes="class python:'odd' if oddrow else 'even'; id string:${groupId}">
                            <td>
                                <a href="@@usergroup-groupdetails"
                                   tal:attributes="href string:@@group-view?groupname=${groupId}">
                                <tal:block replace="structure portal/group.png"/>&nbsp;<span
                                             tal:replace="group/getGroupTitleOrName">group name</span>
                                </a>
                            </td>

                            <td>
                                <tal:authored tal:condition="python: member.getId() in group.getProperty('delegated_group_member_managers')">
                                  <form action=""
                                        name="groups_edit"
                                        method="post"
                                        tal:attributes="action string:@@edit-group-details?groupname=${groupId}">
                         
                                      <input class="actionButtonsSimple"
                                             type="submit"
                                             name="form.button.EditGroup"
                                             value="Edit"
                                             i18n:attributes="value label_edit_group;"
                                      />
                                  </form>
                                </tal:authored>
                            </td>

                            <td style="text-align: center;">
                                <a id="delete_group"
                                   href="javascript: $(#delete_group).remove();"
                                   tal:attributes="id string: ${groupId}; href string:javascript: if (confirm('Estas segur?')) {removeSelectedGroup('#${groupId}');;}">
                                   <input class="actionButtonsSimple"
                                          type="button"
                                          name="deletefromgroup"
                                          value="X"
                                    />
                                </a>
                            </td>
                        </tr>
                    </tal:block>
                  </table>
                  <p tal:condition="not:groups" i18n:translate="text_user_not_in_any_group">This user does not belong to any group.</p>
                </div>

                <div class="span7">
                  <h2 class="arial15c666666" 
                      tal:condition="many_groups" 
                      i18n:translate="heading_search_groups">
                        Search for groups
                  </h2>
                  <h2 class="arial15c666666" 
                      tal:condition="not:many_groups" 
                      i18n:translate="heading_assign_to_groups">
                        Assign to groups
                  </h2>
                  <br/>

                  <form method="post"
                        tal:attributes="action string:$portal_url/$template_id">

                    <table class="dashboardListing" summary="Groups">
                      <tr>
                        <th colspan="2" tal:condition="many_groups">
                          <span tal:omit-tag="" i18n:translate="label_quick_search">Quick search</span>:
                                <input class="quickSearch"
                                       type="text"
                                       name="searchstring"
                                       value=""
                                       tal:attributes="value view/searchString;"
                                       />

                                <input type="submit"
                                       class="searchButton"
                                       name="form.button.search"
                                       value="Search"
                                       i18n:attributes="value label_search;" />

                        </th>
                      </tr>
                      <tal:block condition="python:results">
                          <tr>
                            <th>
                                <input class="noborder"
                                       type="checkbox"
                                       src="select_all_icon.png"
                                       name="selectButton"
                                       title="Select all items"
                                       onClick="toggleSelect(this, 'add:list');"
                                       tal:attributes="src string:${context/portal_url}/select_all_icon.png"
                                       alt="Select all items"
                                       i18n:attributes="title label_select_all_items; alt label_select_all_items;"/>
                            </th>
                            <th i18n:translate="listingheader_group_name">Group Name</th>
                          </tr>
                          <tal:block repeat="obj batch">
                            <tr tal:define="oddrow repeat/obj/odd;
                                            calcId obj/id;
                                            userid userid | nothing;
                                            groupname groupname | nothing;
                                            member context/@@plone_portal_state/member;
                                            m python:userid and member or context.portal_membership.getMemberById(calcId);
                                            g python:groupname and groupname or calcId;
                                            canAddToGroup python:m.canAddToGroup(g) and view.is_zope_manager"
                                tal:attributes="class python:'odd' if oddrow else 'even'">

                              <td class="listingCheckbox">
                                <input type="checkbox"
                                       class="noborder"
                                       name="add:list"
                                       value="value"
                                       tal:attributes="value calcId;
                                                       " />
                              </td>

                              <td tal:define="groupObj python: context.portal_groups.getGroupById(g)">
                                  <img src="group.png" alt="" />
                                  <a href="" tal:attributes="href string:@@group-view?groupname=${g}"
                                            tal:content="groupObj/getGroupTitleOrName">
                                        <span i18n:translate="link_groupname_not_available">
                                            groupname not available
                                        </span>
                                  </a>
                              </td>

                            </tr>
                          </tal:block>
                      </tal:block>
                    </table>

                    <div metal:use-macro="context/batch_macros/macros/navigation" />

                    <div class="showAllSearchResults"
                         tal:condition="python:batch.next or batch.previous"
                         tal:define="mq python:modules['ZTUtils'].make_query;
                                     keys batchformkeys|nothing;
                                     linkparams python:keys and dict([(key, request.form[key]) for key in keys if key in request]) or request.form;
                                     url batch_base_url | string:${context/absolute_url}/${template_id}">
                        <a tal:attributes="href python: '%s?%s' % (url, mq( linkparams, {'showAll':'y'} ))"
                           i18n:translate="description_pas_show_all_search_results">
                            Show all search results
                        </a>
                    </div>

                    <input type="hidden" value="b_start" name="b_start"
                           tal:attributes="value b_start"/>

                    <input type="hidden" value="" name="showAll"
                           tal:attributes="value showAll"/>

                    <input type="hidden" name="form.submitted" value="1" />

                    <input class="boto_filtres arial11c666666 actionButtons"
                           style="float: none;"
                           type="submit"
                           name="form.button.Add"
                           value="Add user to selected groups"
                           tal:condition="batch"
                           i18n:attributes="value label_add_user_to_group;" />
                    <input tal:replace="structure context/@@authenticator/authenticator" />
                  </form>
                </div>
              </div>
            </div>
        </div>
    </tal:main-macro>
</metal:main>

</body>
</html>
